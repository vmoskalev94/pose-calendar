# Бекенд

Owner: mv_vm
Number: 40

## 1. Общая структура проекта

Один Spring Boot-сервис:

`pose-calendar-backend/`

- `src/main/java/com/yourname/posecalendar`
    - `config` – общие конфиги (Spring, Swagger, CORS, Jackson).
    - `security` – Spring Security + JWT.
    - `common` – базовые классы:
        - `BaseEntity`, `ApiError`, `GlobalExceptionHandler`, utils.
    - `storage` – файловое хранилище:
        - `FileStorageService` (интерфейс)
        - `LocalFileStorageService`
        - (позже) `YandexObjectStorageService`
    - `user` – пользователи.
    - `auth` – логин/аутентификация.
    - `packs` – всё, что касается паков (доменные классы, репы, сервисы, контроллеры).
    - `releases` – релизы и их привязка к календарю.
    - `posts` – черновики постов по площадкам.
- `src/main/resources`
    - `application.yml` (+ профили `dev`, `prod`).
- `docker-compose.yml` – `app + postgres` (позже можно добавить nginx и MinIO/YOS).

Стиль: **feature-based внутри бэка**

Каждый модуль (`packs`, `releases`, `auth` и т.д.) содержит свои `controller / service / repository / model / dto`.

---

## 2. Доменная модель и сущности

- 2.1. Пользователь и авторизация
    
    **User**
    
    - `id: UUID`
    - `email: String` (уникальный логин)
    - `displayName: String`
    - `passwordHash: String`
    - `role: Role` (enum, например `ADMIN` / `USER`)
    - `createdAt`, `updatedAt`
    
    **Role (enum)**
    
    Простейшая роль, пока хватит:
    
    ```java
    public enum Role { ADMIN, USER }
    
    ```
    
    **Связи:**
    
    Сейчас один пользователь, но модель готова к 10–100:
    
    `User 1 — M Pack`, `User 1 — M Release` (создатель).
    
- 2.2. Площадки/платформы
    
    **Platform (enum)**
    
    ```java
    public enum Platform {
        TELEGRAM,
        VK,
        BOOSTY,
        TUMBLR
        // later: PATREON, TIKTOK, etc.
    }
    
    ```
    
    Используется в релизах и черновиках постов.
    

---

- 2.3. Пак (Pack) и всё, что к нему относится
    
    **Pack**
    
    Это «главный объект» — набор поз.
    
    Поля:
    
    - `id: UUID`
    - `owner: User` (ManyToOne) – на всякий случай
    - `titleRu: String` – название на русском
    - `titleEn: String` – название на английском (опционально)
    - `description: String` – краткое описание/атмосфера
    - `packType: PackType` (enum: `SOLO`, `COUPLE`, `MIXED`)
    - `status: PackStatus` (enum: `IDEA`, `IN_PROGRESS`, `READY`, `RELEASED`, `ARCHIVED`)
    - `hashtags: String` – сырая строка с хэштегами, которые пойдут в посты
    - `poseCount: Integer` (общее кол-во поз)
    - `hasAllInOne: boolean`
    - `notes: String` – любые заметки
    - `createdAt`, `updatedAt`
    
    **PackType (enum)**
    
    `SOLO`, `COUPLE`, `GROUP`, `OTHER` – можно расширять.
    
    **PackStatus (enum)**
    
    `IDEA`, `IN_PROGRESS`, `READY`, `RELEASED`, `ARCHIVED`.
    

---

- 2.3.1. Файлы пака
    
    Все ассеты принадлежат паку.
    
    **PackFile**
    
    - `id: UUID`
    - `pack: Pack` (ManyToOne)
    - `fileType: PackFileType` (enum)
        - `COVER` – главная обложка
        - `PREVIEW` – коллажи/превью
        - `SCREENSHOT` – отдельные скрины
        - `ARCHIVE` – .package / .zip
        - `INSTRUCTION` – PDF/текстовые инструкции (если отдельным файлом)
        - `EXTRA` – всё остальное
    - `storagePath: String` – путь/ключ для хранилища
        
        (например, `users/{userId}/packs/{packId}/cover_1.png`)
        
    - `originalFilename: String`
    - `contentType: String`
    - `sizeBytes: long`
    - `createdAt`
    
    Физически сейчас кладём в локальную файловую систему, в будущем — в YOS.
    
    **Связь:** `Pack 1 — M PackFile`.
    

---

- 2.3.2. Чек-лист по паку
    
    На макете у тебя фиксированный список задач, но их удобно хранить в БД, чтобы:
    
    - отмечать выполненные,
    - при создании пака автоматически генерить стандартный набор.
    
    **PackTask**
    
    - `id: UUID`
    - `pack: Pack` (ManyToOne)
    - `taskType: PackTaskType` (enum)
    - `customTitle: String` (на случай кастомной задачи; для стандартных — можно null)
    - `completed: boolean`
    - `orderIndex: int` – порядок отображения
    
    **PackTaskType (enum)**, по макету:
    
    - `CREATE_POSES`
    - `TEST_IN_GAME`
    - `MAKE_SCREENSHOTS`
    - `MAKE_COVER`
    - `PREPARE_POST_TEXT`
    - `BUILD_PACKAGE_ARCHIVE`
    - `PREPARE_POST_TELEGRAM`
    - `PREPARE_POST_VK`
    - `PREPARE_POST_BOOSTY`
    - `PREPARE_POST_TUMBLR`
    - etc.
    
    При создании нового `Pack` сервис:
    
    - создаёт записи `PackTask` с нужным `taskType` и `orderIndex`,
    - `completed=false`.

---

- 2.4. Релизы и календарь
    
    **Release**
    
    Событие во времени: «этот пак выходит/анонсируется там-то».
    
    - `id: UUID`
    - `owner: User` (если нужно)
    - `title: String` – название релиза (по макету)
    - `pack: Pack` (ManyToOne)
    - `releaseDateTime: LocalDateTime`
    - `status: ReleaseStatus` (enum; например: `PLANNED`, `CONTENT_READY`, `POSTED`, `CANCELLED`)
    - `notes: String` – любые заметки
    - `createdAt`, `updatedAt`
    
    **Связи:**
    
    - `Pack 1 — M Release`
    - Для календаря берём все релизы в диапазоне дат → раскладываем по дням.
    
    **ReleaseStatus (enum)**
    
    - `PLANNED`
    - `CONTENT_READY` – всё готово, ждёт публикации
    - `POSTED`
    - `CANCELLED`

---

- 2.4.1. Статус релиза по площадкам
    
    На уровне релиза нам нужны статусы по каждой платформе, причём:
    
    - не все релизы идут на все платформы,
    - каждая платформа имеет свой «workflow».
    
    **ReleasePlatform**
    
    - `id: UUID`
    - `release: Release` (ManyToOne)
    - `platform: Platform` (enum)
    - `status: ReleasePlatformStatus` (enum)
    - `plannedDateTime: LocalDateTime` (опционально — если нужно другое время для конкретной платформы)
    - `publishedDateTime: LocalDateTime` (когда реально выложили)
    - `notes: String`
    
    **ReleasePlatformStatus (enum)**
    
    - `NOT_PLANNED` (опционально, можно не хранить)
    - `PLANNED`
    - `DRAFT_PREPARED`
    - `PUBLISHED`
    
    **Связи:**
    
    - `Release 1 — M ReleasePlatform`
    - На модалке релиза можно выводить чекбоксы-платформы + их статусы.

---

- 2.5. Черновики постов (Post drafts)
    
    Менеджер постов: хранить/редактировать тексты постов для каждой площадки.
    
    **PostDraft**
    
    - `id: UUID`
    - `releasePlatform: ReleasePlatform` (OneToOne или ManyToOne)
    
    - `title: String` – заголовок поста (если нужен)
    - `body: String` – основной текст (Boosty / VK / TG)
    - `hashtags: String`
    - `cta: String` – призыв к действию (опционально)
    - `language: String` (например, `ru`, `en`, если будут переводы)
    - `createdAt`, `updatedAt`
    
    **Связи:**
    
    - `ReleasePlatform 1 — 0..1 PostDraft`
        
        (для какой-то платформы можно не заводить draft, например, Boosty уже оформлен вручную).
        
    
    Фронт:
    
    - в карточке пака/релиза можно иметь вкладку «Посты», где по платформам редактируются эти текстовые поля.

---

## 3. Хранение файлов: абстракция под локалку и YOS

### 3.1. Интерфейс хранилища

```java
public interface FileStorageService {

    StoredFile save(InputStream data, String path, String contentType);

    InputStream load(String path);

    void delete(String path);
}

```

`StoredFile` – маленький DTO: `path`, `sizeBytes`, `contentType`.

### 3.2. Локальная реализация

`LocalFileStorageService implements FileStorageService`

- Базовый каталог берём из конфига:
    - `storage.local.base-path=/data/pose-calendar`
- Реальный путь = `basePath + "/" + path`
- Используем `Files.copy(...)`, `Files.newInputStream(...)`.

### 3.3. В будущем: Yandex Object Storage

`YandexObjectStorageService implements FileStorageService`

- Через S3-совместимый клиент (endpoint, bucket, accessKey, secretKey).
- `path` становится `key` в бакете.

Все сервисы, которые работают с файлами (`PackService`), видят только интерфейс, а не конкретную реализацию.

---

## 4. Слои и пакеты по фичам

Пример для `packs` (аналогично для других):

`com.yourname.posecalendar.packs`

- `model`
    - `Pack`, `PackStatus`, `PackType`
    - `PackFile`, `PackFileType`
    - `PackTask`, `PackTaskType`
- `repository`
    - `PackRepository extends JpaRepository<Pack, UUID>`
    - `PackFileRepository`
    - `PackTaskRepository`
- `service`
    - `PackService` – бизнес-логика (создание/редактирование, генерация дефолтного чек-листа, работа с файлами через `FileStorageService`)
- `web`
    - `PackController` – REST API
    - `dto` – `PackDto`, `CreatePackRequest`, `UpdatePackRequest`, `PackFileDto`, и т.п.
    - мапперы (MapStruct или руками).

`releases`, `posts`, `auth`, `user` будут иметь аналогичную структуру: `model/repository/service/web`.

---

## 5. Базовые REST-контроллеры (очень кратко)

Чтобы проверить, что модель закрывает всё:

- `/api/auth/login` – логин, выдаёт JWT.
- `/api/auth/me` – текущий пользователь.
- `/api/packs`
    - `GET /` – список паков (с фильтрами/поиском).
    - `GET /{id}` – полная карточка пака.
    - `POST /` – создать пак.
    - `PUT /{id}` – изменить.
    - `DELETE /{id}` – удалить.
- `/api/packs/{id}/files`
    - `POST` – загрузить файл (multipart).
    - `GET` – список файлов пака.
    - `DELETE /{fileId}` – удалить.
- `/api/packs/{id}/tasks`
    - `GET` – чеклист.
    - `PATCH /{taskId}` – отметить выполненным/изменить.
- `/api/releases`
    - `GET?fromDate=...&toDate=...` – релизы для календаря.
    - `POST` – создать.
    - `PUT /{id}` – изменить.
    - `DELETE /{id}` – удалить.
- `/api/releases/{id}/platforms`
    - `GET` – статусы по платформам.
    - `PUT /{platform}` – поменять статус, дату и т.п.
- `/api/platforms/{releasePlatformId}/post-draft`
    - `GET` – получить черновик поста.
    - `PUT` – обновить/создать.

Этого достаточно, чтобы накрыть все UI-кейсы из макетов.

---